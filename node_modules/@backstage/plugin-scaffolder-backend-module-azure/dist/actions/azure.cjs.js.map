{"version":3,"file":"azure.cjs.js","sources":["../../src/actions/azure.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { InputError } from '@backstage/errors';\nimport {\n  DefaultAzureDevOpsCredentialsProvider,\n  ScmIntegrationRegistry,\n} from '@backstage/integration';\nimport {\n  createTemplateAction,\n  getRepoSourceDirectory,\n  initRepoAndPush,\n  parseRepoUrl,\n} from '@backstage/plugin-scaffolder-node';\nimport { GitRepositoryCreateOptions } from 'azure-devops-node-api/interfaces/GitInterfaces';\nimport {\n  getBearerHandler,\n  getPersonalAccessTokenHandler,\n  WebApi,\n} from 'azure-devops-node-api';\nimport { Config } from '@backstage/config';\nimport { examples } from './azure.examples';\n\n/**\n * Creates a new action that initializes a git repository of the content in the workspace\n * and publishes it to Azure.\n * @public\n */\nexport function createPublishAzureAction(options: {\n  integrations: ScmIntegrationRegistry;\n  config: Config;\n}) {\n  const { integrations, config } = options;\n\n  return createTemplateAction<{\n    repoUrl: string;\n    description?: string;\n    defaultBranch?: string;\n    sourcePath?: string;\n    token?: string;\n    gitCommitMessage?: string;\n    gitAuthorName?: string;\n    gitAuthorEmail?: string;\n    signCommit?: boolean;\n  }>({\n    id: 'publish:azure',\n    examples,\n    description:\n      'Initializes a git repository of the content in the workspace, and publishes it to Azure.',\n    schema: {\n      input: {\n        type: 'object',\n        required: ['repoUrl'],\n        properties: {\n          repoUrl: {\n            title: 'Repository Location',\n            type: 'string',\n          },\n          description: {\n            title: 'Repository Description',\n            type: 'string',\n          },\n          defaultBranch: {\n            title: 'Default Branch',\n            type: 'string',\n            description: `Sets the default branch on the repository. The default value is 'master'`,\n          },\n          gitCommitMessage: {\n            title: 'Git Commit Message',\n            type: 'string',\n            description: `Sets the commit message on the repository. The default value is 'initial commit'`,\n          },\n          gitAuthorName: {\n            title: 'Default Author Name',\n            type: 'string',\n            description: `Sets the default author name for the commit. The default value is 'Scaffolder'`,\n          },\n          gitAuthorEmail: {\n            title: 'Default Author Email',\n            type: 'string',\n            description: `Sets the default author email for the commit.`,\n          },\n          sourcePath: {\n            title: 'Source Path',\n            description:\n              'Path within the workspace that will be used as the repository root. If omitted, the entire workspace will be published as the repository.',\n            type: 'string',\n          },\n          token: {\n            title: 'Authentication Token',\n            type: 'string',\n            description: 'The token to use for authorization to Azure',\n          },\n          signCommit: {\n            title: 'Sign commit',\n            type: 'boolean',\n            description: 'Sign commit with configured PGP private key',\n          },\n        },\n      },\n      output: {\n        type: 'object',\n        properties: {\n          remoteUrl: {\n            title: 'A URL to the repository with the provider',\n            type: 'string',\n          },\n          repoContentsUrl: {\n            title: 'A URL to the root of the repository',\n            type: 'string',\n          },\n          repositoryId: {\n            title: 'The Id of the created repository',\n            type: 'string',\n          },\n          commitHash: {\n            title: 'The git commit hash of the initial commit',\n            type: 'string',\n          },\n        },\n      },\n    },\n    async handler(ctx) {\n      const {\n        repoUrl,\n        defaultBranch = 'master',\n        gitCommitMessage = 'initial commit',\n        gitAuthorName,\n        gitAuthorEmail,\n        signCommit,\n      } = ctx.input;\n\n      const { project, repo, host, organization } = parseRepoUrl(\n        repoUrl,\n        integrations,\n      );\n\n      if (!organization) {\n        throw new InputError(\n          `Invalid URL provider was included in the repo URL to create ${ctx.input.repoUrl}, missing organization`,\n        );\n      }\n\n      const url = `https://${host}/${organization}`;\n      const credentialProvider =\n        DefaultAzureDevOpsCredentialsProvider.fromIntegrations(integrations);\n      const credentials = await credentialProvider.getCredentials({ url: url });\n      const integrationConfig = integrations.azure.byHost(host);\n\n      if (credentials === undefined && ctx.input.token === undefined) {\n        throw new InputError(\n          `No credentials provided ${url}, please check your integrations config`,\n        );\n      }\n\n      const authHandler =\n        ctx.input.token || credentials?.type === 'pat'\n          ? getPersonalAccessTokenHandler(ctx.input.token ?? credentials!.token)\n          : getBearerHandler(credentials!.token);\n\n      const webApi = new WebApi(url, authHandler);\n      const client = await webApi.getGitApi();\n      const createOptions: GitRepositoryCreateOptions = { name: repo };\n\n      const { remoteUrl, repositoryId, repoContentsUrl } = await ctx.checkpoint(\n        {\n          key: `create.repo.${repo}`,\n          fn: async () => {\n            const returnedRepo = await client.createRepository(\n              createOptions,\n              project,\n            );\n\n            if (!returnedRepo) {\n              throw new InputError(\n                `Unable to create the repository with Organization ${organization}, Project ${project} and Repo ${repo}.\n          Please make sure that both the Org and Project are typed corrected and exist.`,\n              );\n            }\n\n            if (!returnedRepo.remoteUrl) {\n              throw new InputError(\n                'No remote URL returned from create repository for Azure',\n              );\n            }\n\n            if (!returnedRepo.id) {\n              throw new InputError(\n                'No Id returned from create repository for Azure',\n              );\n            }\n\n            if (!returnedRepo.webUrl) {\n              throw new InputError(\n                'No web URL returned from create repository for Azure',\n              );\n            }\n\n            return {\n              remoteUrl: returnedRepo.remoteUrl,\n              repositoryId: returnedRepo.id,\n              repoContentsUrl: returnedRepo.webUrl,\n            };\n          },\n        },\n      );\n\n      const gitAuthorInfo = {\n        name: gitAuthorName\n          ? gitAuthorName\n          : config.getOptionalString('scaffolder.defaultAuthor.name'),\n        email: gitAuthorEmail\n          ? gitAuthorEmail\n          : config.getOptionalString('scaffolder.defaultAuthor.email'),\n      };\n\n      const auth = {\n        username: 'notempty',\n        password: ctx.input.token ?? credentials!.token,\n      };\n\n      const signingKey =\n        integrationConfig?.config.commitSigningKey ??\n        config.getOptionalString('scaffolder.defaultCommitSigningKey');\n      if (signCommit && !signingKey) {\n        throw new Error(\n          'Signing commits is enabled but no signing key is provided in the configuration',\n        );\n      }\n\n      const commitHash = await ctx.checkpoint({\n        key: `init.repo.and.push.${remoteUrl}`,\n        fn: async () => {\n          const commitResult = await initRepoAndPush({\n            dir: getRepoSourceDirectory(\n              ctx.workspacePath,\n              ctx.input.sourcePath,\n            ),\n            remoteUrl,\n            defaultBranch,\n            auth: auth,\n            logger: ctx.logger,\n            commitMessage: gitCommitMessage\n              ? gitCommitMessage\n              : config.getOptionalString('scaffolder.defaultCommitMessage'),\n            gitAuthorInfo,\n            signingKey: signCommit ? signingKey : undefined,\n          });\n\n          return commitResult?.commitHash;\n        },\n      });\n\n      ctx.output('commitHash', commitHash);\n      ctx.output('remoteUrl', remoteUrl);\n      ctx.output('repoContentsUrl', repoContentsUrl);\n      ctx.output('repositoryId', repositoryId);\n    },\n  });\n}\n"],"names":["createTemplateAction","examples","parseRepoUrl","InputError","DefaultAzureDevOpsCredentialsProvider","getPersonalAccessTokenHandler","getBearerHandler","WebApi","initRepoAndPush","getRepoSourceDirectory"],"mappings":"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"}